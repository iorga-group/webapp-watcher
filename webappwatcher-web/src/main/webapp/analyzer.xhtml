<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
	xmlns:fn="http://java.sun.com/jsp/jstl/functions"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui">

	<h:head>
		<title>WebappWatcher - Analyzer</title>
		<h:outputScript library="js" name="jquery.flot.js"/>
		<h:outputScript library="js" name="jquery.flot.time.js"/>
		<h:outputScript library="js" name="jquery.flot.resize.js"/>
		<h:outputScript library="js" name="jquery.flot.crosshair.js"/>
		<h:outputScript library="js" name="jquery.flot.navigate.js"/>
		<h:outputScript library="js" name="analyzer.js"/>
		<style>
			html {
				height: 100%;
			}
			body {
				height: 100%;
			}
			.stackElement {
				margin-left: 10px;
			}
		</style>
	</h:head>
	
	<h:body>
		<p:panel id="analyzer" header="Analyzer">
			<h:form enctype="multipart/form-data" rendered="#{not analyzerAction.retentionLogLoaded}">
				<p:fileUpload
					fileUploadListener="#{analyzerAction.handleFileUpload}"
					mode="advanced"
					update=":analyzer"
					showButtons="false"
					auto="true"
					allowTypes="/(\.|\/)(xz|gz)$/" />
			</h:form>
			<h:form prependId="false" rendered="#{analyzerAction.retentionLogLoaded}">
				<div id="placeholder" style="width:100%;height:600px;"></div>
				<p:outputPanel id="infoPanel">
					Limit to :
					<p:selectOneMenu value="#{analyzerAction.selectedPrincipal}" filter="true" filterMatchMode="contains">
						<f:selectItem itemLabel="All" itemValue="#{analyzerAction.allPrincipalValue}"/>
						<f:selectItems value="#{analyzerAction.colorsByPrincipal.entrySet()}" var="entry" itemLabel="#{entry.key}" itemValue="#{entry.key}" />
					</p:selectOneMenu>
					<h:commandButton value="Submit" action="#{analyzerAction.changeSelectedPrincipal}"/>  
					Selected date : <h:outputText value="#{analyzerAction.selectedTime}"><f:convertDateTime type="both" dateStyle="full"/></h:outputText>
					<p:fieldset legend="System" rendered="#{not empty analyzerAction.selectedSystemEventLog}">
						<ul>
							<li>Time diff with selected : <h:outputText value="#{analyzerAction.selectedTime - analyzerAction.selectedSystemEventLog.date.time}" style="background-color: ##{analyzerAction.selectedSystemEventLogTimeColor}" /> ms</li>
							<li>CPU : <h:outputText value="#{analyzerAction.selectedSystemEventLog.cpuUsage}" /> %</li>
							<li>Heap Memory : <h:outputText value="#{analyzerAction.selectedSystemEventLog.heapMemoryUsed / (1024 * 1024)}"><f:convertNumber maxFractionDigits="2"/></h:outputText> MB</li>
							<li>Non Heap Memory : <h:outputText value="#{analyzerAction.selectedSystemEventLog.nonHeapMemoryUsed / (1024 * 1024)}"><f:convertNumber maxFractionDigits="2"/></h:outputText> MB</li>
							<li>Thread count : <h:outputText value="#{analyzerAction.selectedSystemEventLog.threadCount}" /></li>
							<li>Peak Thread count : <h:outputText value="#{analyzerAction.selectedSystemEventLog.peakThreadCount}" /></li>
						</ul>
						<p:fieldset legend="Running or Blocked Threads" toggleable="true" rendered="#{not empty analyzerAction.selectedSystemEventLog.blockedOrRunningThreads}">
							<ul>
							<ui:repeat var="thread" value="#{analyzerAction.selectedSystemEventLog.blockedOrRunningThreads}">
								<li>#{thread.name}(##{thread.id}) - #{thread.state}</li>
								<ul>
								<ui:repeat var="stackElement" value="#{thread.stackTrace}">
									<li>#{stackElement.className}.#{stackElement.methodName}(#{stackElement.fileName}:#{stackElement.lineNumber})</li>
								</ui:repeat>
								</ul>
							</ui:repeat>
							</ul>
						</p:fieldset>
					</p:fieldset>
					<p:fieldset legend="Requests" rendred="#{not empty analyzerAction.selectedRequestEventLogs}">
						<ul>
							<ui:repeat var="requestEvent" value="#{analyzerAction.selectedRequestEventLogs}">
								<li>#{requestEvent.requestURI} (#{requestEvent.principal})</li>
								<ul>
									<li>Method : #{requestEvent.method}</li>
									<li>Thread : #{requestEvent.threadName} (#{requestEvent.threadId})</li>
									<li>Start date : #{requestEvent.date}</li>
									<li>End date : #{requestEvent.afterProcessedDate}</li>
									<li>Duration : #{requestEvent.durationMillis}</li>
									<li>Parameters</li>
									<ul>
										<ui:repeat var="parameter" value="#{requestEvent.parameters}">
											<li>#{parameter.name} = #{fn:join(parameter.values, ', ')}</li>
										</ui:repeat>
									</ul>
									<li>Headers</li>
									<ul>
										<ui:repeat var="requestHeader" value="#{requestEvent.headers}">
											<li>#{requestHeader.name} = #{requestHeader.value}</li>
										</ui:repeat>
									</ul>
								</ul>
							</ui:repeat>
						</ul>
					</p:fieldset>
				</p:outputPanel>
				<p:remoteCommand name="updateInfoPanel" update="infoPanel" action="#{analyzerAction.updateInfoPanel}" />
				<h:inputHidden id="selectedTime" value="#{analyzerAction.selectedTime}" />
				
				<script id="source">
$(function () {
	var cpuUsageValues = [#{analyzerAction.cpuUsageJsonValues}];
	var memoryUsedValues = [#{analyzerAction.memoryUsedJsonValues}];
	var markings = [#{analyzerAction.markingsJson}];
	initAnalyzer(cpuUsageValues, memoryUsedValues, markings, #{analyzerAction.firstEventLogDate.time}, #{analyzerAction.lastEventLogDate.time}, #{analyzerAction.maxMemoryUsed});
});
				</script>
			</h:form>
		</p:panel>
	</h:body>
</html>
